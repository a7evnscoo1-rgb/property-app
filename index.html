<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ä¸å‹•ç”£æŠ•è³‡ã®åˆ¤æ–­ãƒ„ãƒ¼ãƒ«">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <title>ç‰©ä»¶åˆ¤æ–­ã‚¢ãƒ—ãƒª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #f9fafb;
            position: relative;
            min-height: 100vh;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
            z-index: 0;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            background: rgba(31, 41, 55, 0.5);
            padding: 5px;
            border-radius: 12px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0 15px 0;
            color: #e5e7eb;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 8px;
        }
        
        .form-group { margin-bottom: 15px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e5e7eb;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="checkbox"],
        select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 15px;
            background: rgba(31, 41, 55, 0.5);
            color: #f9fafb;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
        }
        
        input[type="number"] { text-align: right; }
        
        input:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        }
        
        .btn-secondary {
            background: rgba(75, 85, 99, 0.5);
            color: #e5e7eb;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(75, 85, 99, 0.8);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .result-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(31, 41, 55, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .result-item {
            text-align: center;
            padding: 15px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
        }
        
        .result-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-value.large { font-size: 32px; }
        
        .alert {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            color: #fca5a5;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10b981;
            color: #6ee7b7;
        }
        
        .property-list {
            margin-top: 20px;
        }
        
        .property-item {
            background: rgba(31, 41, 55, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .property-item:hover {
            background: rgba(31, 41, 55, 0.8);
        }
        
        .property-info {
            flex: 1;
        }
        
        .property-name {
            font-size: 16px;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 5px;
        }
        
        .property-details {
            font-size: 13px;
            color: #9ca3af;
        }
        
        .property-price {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 15px;
        }
        
        .property-actions {
            display: flex;
            gap: 8px;
        }
        
        .hidden { display: none !important; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .result-grid { grid-template-columns: 1fr; }
            .property-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .property-actions {
                width: 100%;
            }
            .btn-small {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-title">ğŸ  ç‰©ä»¶åˆ¤æ–­ã‚¢ãƒ—ãƒª</div>
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('simple')">ğŸ“Š ç°¡æ˜“åˆ¤æ–­</button>
                <button class="tab-btn" onclick="switchTab('detailed')">ğŸ“ˆ è©³ç´°åˆ†æ</button>
                <button class="tab-btn" onclick="switchTab('saved')">ğŸ’¾ ä¿å­˜æ¸ˆã¿</button>
            </div>
        </div>
        
        <!-- ç°¡æ˜“ç‰ˆã‚¿ãƒ– -->
        <div id="simpleTab" class="tab-content active">
            <div class="card">
                <h2 style="color: #e5e7eb; margin-bottom: 20px;">ç´ æ—©ãæ¨å¥¨è³¼å…¥ä¾¡æ ¼ã‚’è¨ˆç®—</h2>
                
                <div class="form-group">
                    <label>ç‰©ä»¶å</label>
                    <input type="text" id="s_name" placeholder="ä¾‹ï¼šç¥æˆ¸å¸‚è¥¿åŒºå²©å²¡ç”º">
                </div>
                
                <div class="form-group">
                    <label>æƒ³å®šå®¶è³ƒï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
                    <input type="number" id="s_rent" value="55000">
                </div>
                
                <div class="form-group">
                    <label>ç›®æ¨™è¡¨é¢åˆ©å›ã‚Šï¼ˆ%ï¼‰</label>
                    <input type="number" id="s_yield" value="13" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>ãƒªãƒ•ã‚©ãƒ¼ãƒ è²»ç”¨ï¼ˆå††ï¼‰</label>
                    <input type="number" id="s_reform" value="1700000">
                </div>
                
                <button class="btn btn-primary" onclick="calcSimple()">ğŸ’¡ è¨ˆç®—ã™ã‚‹</button>
                
                <div id="s_result" class="result-section hidden">
                    <div class="result-item">
                        <div class="result-label">å¹´é–“å®¶è³ƒåå…¥</div>
                        <div class="result-value" id="s_annual"></div>
                    </div>
                    <div class="result-item" style="margin-top: 20px;">
                        <div class="result-label">æ¨å¥¨ç‰©ä»¶è³¼å…¥ä¾¡æ ¼</div>
                        <div class="result-value large" id="s_price"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveSimple()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
        
        <!-- è©³ç´°ç‰ˆã‚¿ãƒ–ï¼ˆå‰å›ã¨åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’ç¶™ç¶šï¼‰ -->
        <div id="detailedTab" class="tab-content">
            <div class="card">
                <h2 style="color: #e5e7eb; margin-bottom: 10px;">è©³ç´°ãªåæ”¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                
                <div class="form-group">
                    <label>ç‰©ä»¶å</label>
                    <input type="text" id="d_name" placeholder="ä¾‹ï¼šç¥æˆ¸å¸‚è¥¿åŒºå²©å²¡ç”º">
                </div>
                
                <div class="section-title">åŸºæœ¬æƒ…å ±</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>ç‰©ä»¶ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_price" value="2500000">
                    </div>
                    <div class="form-group">
                        <label>ãƒªãƒ•ã‚©ãƒ¼ãƒ è²»ç”¨ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_reform" value="1700000">
                    </div>
                    <div class="form-group">
                        <label>æƒ³å®šå®¶è³ƒï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
                        <input type="number" id="d_rent" value="55000">
                    </div>
                    <div class="form-group">
                        <label>ç©ºå®¤ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="d_vacancy" value="15">
                    </div>
                </div>
                
                <div class="section-title">åœŸåœ°å€¤è¨ˆç®—</div>
                <div class="form-group">
                    <label>åœŸåœ°é¢ç©ï¼ˆã¡ï¼‰</label>
                    <input type="number" id="d_landArea" value="72.31" step="0.01">
                </div>
                <div class="form-group">
                    <label>è©•ä¾¡æ–¹æ³•</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="landMethod" value="inheritance" checked onchange="toggleLandMethod()">
                            ç›¸ç¶šç¨è·¯ç·šä¾¡
                        </label>
                        <label>
                            <input type="radio" name="landMethod" value="property" onchange="toggleLandMethod()">
                            å›ºå®šè³‡ç”£ç¨è©•ä¾¡é¡/ã¡
                        </label>
                    </div>
                </div>
                <div id="inheritanceInput">
                    <div class="form-group">
                        <label>ç›¸ç¶šç¨è·¯ç·šä¾¡ï¼ˆå††/ã¡ï¼‰</label>
                        <input type="number" id="d_inheritance" value="50000">
                    </div>
                </div>
                <div id="propertyInput" class="hidden">
                    <div class="form-group">
                        <label>å›ºå®šè³‡ç”£ç¨è©•ä¾¡é¡ï¼ˆå††/ã¡ï¼‰</label>
                        <input type="number" id="d_propertyValue" value="31800">
                    </div>
                </div>
                
                <div class="section-title">è«¸è²»ç”¨</div>
                <div class="form-group">
                    <label>å…¥åŠ›æ–¹æ³•</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="costMethod" value="fixed" checked onchange="toggleCostMethod()">
                            å›ºå®šé¡å…¥åŠ›
                        </label>
                        <label>
                            <input type="radio" name="costMethod" value="detail" onchange="toggleCostMethod()">
                            å€‹åˆ¥å…¥åŠ›
                        </label>
                    </div>
                </div>
                <div id="fixedCostInput">
                    <div class="form-group">
                        <label>è«¸è²»ç”¨åˆè¨ˆï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_costFixed" value="552000">
                    </div>
                </div>
                <div id="detailCostInput" class="hidden">
                    <div class="form-group">
                        <label>åœŸåœ°è©•ä¾¡é¡ï¼ˆå††ï¼‰â€»ç™»è¨˜è²»ç”¨è¨ˆç®—ç”¨</label>
                        <input type="number" id="d_landValue" value="2298000" onchange="calcDetailCosts()">
                    </div>
                    <div class="form-group">
                        <label>ä»²ä»‹æ‰‹æ•°æ–™</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="brokerageMethod" value="auto" checked onchange="toggleBrokerage()">
                                è‡ªå‹•è¨ˆç®—
                            </label>
                            <label>
                                <input type="radio" name="brokerageMethod" value="max" onchange="toggleBrokerage()">
                                ä¸Šé™33ä¸‡å††
                            </label>
                            <label>
                                <input type="radio" name="brokerageMethod" value="manual" onchange="toggleBrokerage()">
                                æ‰‹å…¥åŠ›
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="d_brokerage" readonly style="background: rgba(75, 85, 99, 0.3);">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>ç™»éŒ²å…è¨±ç¨ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                            <input type="number" id="d_regTax" readonly style="background: rgba(75, 85, 99, 0.3);">
                        </div>
                        <div class="form-group">
                            <label>æ‰€æœ‰æ¨©ç§»è»¢ç™»è¨˜è²»ç”¨ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_transfer" value="0">
                        </div>
                        <div class="form-group">
                            <label>å¸æ³•æ›¸å£«å ±é…¬ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_lawyer" value="100000">
                        </div>
                        <div class="form-group">
                            <label>å›ºéƒ½ç¨æ¸…ç®—é‡‘ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_taxAdj" value="10000">
                        </div>
                        <div class="form-group">
                            <label>ç«ç½ä¿é™ºæ–™ãƒ»åˆæœŸï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_insurance0" value="30000">
                        </div>
                        <div class="form-group">
                            <label>ãƒ­ãƒ¼ãƒ³ä¿è¨¼æ–™ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_guarantee" value="25000">
                        </div>
                        <div class="form-group">
                            <label>ãƒ­ãƒ¼ãƒ³äº‹å‹™æ‰‹æ•°æ–™ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_loanFee" value="33000">
                        </div>
                        <div class="form-group">
                            <label>å®¶è³ƒä¿è¨¼ãƒ»åˆå›ï¼ˆå††ï¼‰</label>
                            <input type="number" id="d_guaranteeInitial" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ãã®ä»–è«¸è²»ç”¨ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_other" value="0">
                    </div>
                </div>
                
                <div class="section-title">ãƒ­ãƒ¼ãƒ³æƒ…å ±</div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>ãƒ­ãƒ¼ãƒ³é‡‘é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_loan" value="1700000">
                    </div>
                    <div class="form-group">
                        <label>é‡‘åˆ©ï¼ˆ%ï¼‰</label>
                        <input type="number" id="d_rate" value="3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>è¿”æ¸ˆå¹´æ•°</label>
                        <input type="number" id="d_years" value="10">
                    </div>
                </div>
                
                <div class="section-title">å¹´é–“ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆ</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>ç®¡ç†å§”è¨—è²»ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="d_mgmtRate" value="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ç«ç½ä¿é™ºæ–™ãƒ»å¹´é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_insurance" value="30000">
                    </div>
                    <div class="form-group">
                        <label>å›ºéƒ½ç¨ãƒ»å¹´é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_tax" value="50000">
                    </div>
                    <div class="form-group">
                        <label>ä¿®ç¹•ç©ç«‹é‡‘ãƒ»å¹´é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_repair" value="100000">
                    </div>
                    <div class="form-group">
                        <label>å®¶è³ƒä¿è¨¼ãƒ»æ›´æ–°æ–™ï¼ˆå††ï¼‰</label>
                        <input type="number" id="d_guaranteeAnnual" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>ãã®ä»–ãƒ»å¹´é¡ï¼ˆå††ï¼‰</label>
                    <input type="number" id="d_otherCost" value="0">
                </div>
                
                <button class="btn btn-primary" onclick="calcDetailed()">ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
                
                <div id="d_result" class="result-section hidden">
                    <div id="paymentAlert"></div>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">åœŸåœ°å€¤</div>
                            <div class="result-value" id="d_landVal"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">è¡¨é¢åˆ©å›ã‚Š</div>
                            <div class="result-value" id="d_gross"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">å®Ÿè³ªåˆ©å›ã‚Š</div>
                            <div class="result-value" id="d_net"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">è¿”æ¸ˆæ¯”ç‡</div>
                            <div class="result-value" id="d_ratio"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">å¹´é–“CF</div>
                            <div class="result-value" id="d_cfYear"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">æœˆé–“CF</div>
                            <div class="result-value" id="d_cfMonth"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">æŠ•è³‡å›åå¹´æ•°</div>
                            <div class="result-value" id="d_payback"></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">ç·æŠ•è³‡é¡</div>
                            <div class="result-value" id="d_total"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveDetailed()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
        
        <!-- ä¿å­˜æ¸ˆã¿ã‚¿ãƒ– -->
        <div id="savedTab" class="tab-content">
            <div class="card">
                <h2 style="color: #e5e7eb; margin-bottom: 20px;">ä¿å­˜æ¸ˆã¿ç‰©ä»¶</h2>
                
                <div id="propertyList" class="property-list"></div>
                
                <div id="emptyState" class="empty-state">
                    ã¾ã ç‰©ä»¶ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
                
                <div class="toolbar">
                    <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
        }
        
        let properties = [];
        let currentSimpleCalc = null;
        let currentDetailedCalc = null;
        
        window.onload = function() {
            loadProperties();
            renderPropertyList();
        };
        
        function fmt(v) { return 'Â¥' + Math.round(v).toLocaleString(); }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = ['simpleTab', 'detailedTab', 'savedTab'];
            
            if (tab === 'simple') {
                tabs[0].classList.add('active');
                document.getElementById('simpleTab').classList.add('active');
            } else if (tab === 'detailed') {
                tabs[1].classList.add('active');
                document.getElementById('detailedTab').classList.add('active');
            } else {
                tabs[2].classList.add('active');
                document.getElementById('savedTab').classList.add('active');
                renderPropertyList();
            }
        }
        
        function toggleLandMethod() {
            const method = document.querySelector('input[name="landMethod"]:checked').value;
            document.getElementById('inheritanceInput').classList.toggle('hidden', method !== 'inheritance');
            document.getElementById('propertyInput').classList.toggle('hidden', method !== 'property');
        }
        
        function toggleCostMethod() {
            const method = document.querySelector('input[name="costMethod"]:checked').value;
            document.getElementById('fixedCostInput').classList.toggle('hidden', method !== 'fixed');
            document.getElementById('detailCostInput').classList.toggle('hidden', method !== 'detail');
            if (method === 'detail') calcDetailCosts();
        }
        
        function toggleBrokerage() {
            const method = document.querySelector('input[name="brokerageMethod"]:checked').value;
            const input = document.getElementById('d_brokerage');
            
            if (method === 'manual') {
                input.readOnly = false;
                input.style.background = 'rgba(31, 41, 55, 0.5)';
                input.value = '';
            } else {
                input.readOnly = true;
                input.style.background = 'rgba(75, 85, 99, 0.3)';
                calcDetailCosts();
            }
        }
        
        function calcDetailCosts() {
            const price = parseFloat(document.getElementById('d_price').value) || 0;
            const landVal = parseFloat(document.getElementById('d_landValue').value) || 0;
            const method = document.querySelector('input[name="brokerageMethod"]:checked').value;
            
            let brokerage = 0;
            if (method === 'auto') {
                brokerage = (price * 0.03 + 60000) * 1.1;
            } else if (method === 'max') {
                brokerage = 330000;
            }
            
            if (method !== 'manual') {
                document.getElementById('d_brokerage').value = Math.round(brokerage);
            }
            
            const regTax = landVal * 0.02;
            document.getElementById('d_regTax').value = Math.round(regTax);
        }
        
        function calcSimple() {
            const rent = parseFloat(document.getElementById('s_rent').value) || 0;
            const yld = parseFloat(document.getElementById('s_yield').value) || 0;
            const reform = parseFloat(document.getElementById('s_reform').value) || 0;
            
            const annual = rent * 12;
            const total = annual / (yld / 100);
            const price = total - reform;
            
            currentSimpleCalc = {
                rent, yield: yld, reform, annual, price
            };
            
            document.getElementById('s_annual').textContent = fmt(annual);
            document.getElementById('s_price').textContent = fmt(price);
            document.getElementById('s_result').classList.remove('hidden');
        }
        
        function calcDetailed() {
            const price = parseFloat(document.getElementById('d_price').value) || 0;
            const reform = parseFloat(document.getElementById('d_reform').value) || 0;
            const rent = parseFloat(document.getElementById('d_rent').value) || 0;
            const vacancy = parseFloat(document.getElementById('d_vacancy').value) || 0;
            const loan = parseFloat(document.getElementById('d_loan').value) || 0;
            const rate = parseFloat(document.getElementById('d_rate').value) || 0;
            const years = parseFloat(document.getElementById('d_years').value) || 0;
            
            // åœŸåœ°å€¤
            const landArea = parseFloat(document.getElementById('d_landArea').value) || 0;
            const method = document.querySelector('input[name="landMethod"]:checked').value;
            let landValue = 0;
            if (method === 'inheritance') {
                const inh = parseFloat(document.getElementById('d_inheritance').value) || 0;
                landValue = inh * landArea;
            } else {
                const prop = parseFloat(document.getElementById('d_propertyValue').value) || 0;
                landValue = prop * landArea;
            }
            
            // è«¸è²»ç”¨
            const costMethod = document.querySelector('input[name="costMethod"]:checked').value;
            let totalCost = 0;
            if (costMethod === 'fixed') {
                totalCost = parseFloat(document.getElementById('d_costFixed').value) || 0;
            } else {
                totalCost = 
                    (parseFloat(document.getElementById('d_brokerage').value) || 0) +
                    (parseFloat(document.getElementById('d_regTax').value) || 0) +
                    (parseFloat(document.getElementById('d_transfer').value) || 0) +
                    (parseFloat(document.getElementById('d_lawyer').value) || 0) +
                    (parseFloat(document.getElementById('d_taxAdj').value) || 0) +
                    (parseFloat(document.getElementById('d_insurance0').value) || 0) +
                    (parseFloat(document.getElementById('d_guarantee').value) || 0) +
                    (parseFloat(document.getElementById('d_loanFee').value) || 0) +
                    (parseFloat(document.getElementById('d_guaranteeInitial').value) || 0) +
                    (parseFloat(document.getElementById('d_other').value) || 0);
            }
            
            // ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆ
            const mgmtRate = parseFloat(document.getElementById('d_mgmtRate').value) || 0;
            const mgmt = rent * 12 * (mgmtRate / 100);
            const ins = parseFloat(document.getElementById('d_insurance').value) || 0;
            const tax = parseFloat(document.getElementById('d_tax').value) || 0;
            const repair = parseFloat(document.getElementById('d_repair').value) || 0;
            const guaranteeAnnual = parseFloat(document.getElementById('d_guaranteeAnnual').value) || 0;
            const other = parseFloat(document.getElementById('d_otherCost').value) || 0;
            const totalRunning = mgmt + ins + tax + repair + guaranteeAnnual + other;
            
            // ãƒ­ãƒ¼ãƒ³è¨ˆç®—
            const mRate = rate / 100 / 12;
            const nPay = years * 12;
            let mPay = 0;
            if (loan > 0 && mRate > 0) {
                mPay = loan * mRate * Math.pow(1 + mRate, nPay) / (Math.pow(1 + mRate, nPay) - 1);
            }
            const yPay = mPay * 12;
            
            // åç›Šè¨ˆç®—
            const annual = rent * 12;
            const actualRent = annual * (1 - vacancy / 100);
            const totalInv = price + reform + totalCost;
            const profit = actualRent - totalRunning;
            const cf = profit - yPay;
            
            // åˆ©å›ã‚Š
            const gross = (annual / totalInv) * 100;
            const net = (profit / totalInv) * 100;
            
            // è¿”æ¸ˆæ¯”ç‡
            const payRatio = (yPay / annual) * 100;
            
            // æŠ•è³‡å›å
            const payback = totalInv / profit;
            
            currentDetailedCalc = {
                price, reform, rent, vacancy, loan, rate, years,
                landValue, totalCost, totalRunning, gross, net, 
                cf, payRatio, payback, totalInv
            };
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆ
            const alert = document.getElementById('paymentAlert');
            if (payRatio > 50) {
                alert.innerHTML = '<div class="alert">âš ï¸ è¿”æ¸ˆæ¯”ç‡ãŒ50%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚è³‡é‡‘ç¹°ã‚Šã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</div>';
            } else {
                alert.innerHTML = '<div class="alert alert-success">âœ“ è¿”æ¸ˆæ¯”ç‡ã¯å¥å…¨ãªç¯„å›²å†…ã§ã™ã€‚</div>';
            }
            
            // è¡¨ç¤º
            document.getElementById('d_landVal').textContent = fmt(landValue);
            document.getElementById('d_gross').textContent = gross.toFixed(2) + '%';
            document.getElementById('d_net').textContent = net.toFixed(2) + '%';
            document.getElementById('d_ratio').textContent = payRatio.toFixed(1) + '%';
            document.getElementById('d_cfYear').textContent = fmt(cf);
            document.getElementById('d_cfMonth').textContent = fmt(cf / 12);
            document.getElementById('d_payback').textContent = payback.toFixed(1) + 'å¹´';
            document.getElementById('d_total').textContent = fmt(totalInv);
            
            document.getElementById('d_result').classList.remove('hidden');
            document.getElementById('d_result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function saveSimple() {
            const name = document.getElementById('s_name').value.trim() || 'åå‰ãªã—';
            
            if (!currentSimpleCalc) {
                alert('å…ˆã«è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const property = {
                id: Date.now(),
                name: name,
                type: 'simple',
                simpleData: currentSimpleCalc,
                savedAt: new Date().toLocaleString('ja-JP')
            };
            
            properties.unshift(property);
            saveProperties();
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            switchTab('saved');
        }
        
        function saveDetailed() {
            const name = document.getElementById('d_name').value.trim() || 'åå‰ãªã—';
            
            if (!currentDetailedCalc) {
                alert('å…ˆã«è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const property = {
                id: Date.now(),
                name: name,
                type: 'detailed',
                detailedData: currentDetailedCalc,
                savedAt: new Date().toLocaleString('ja-JP')
            };
            
            properties.unshift(property);
            saveProperties();
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            switchTab('saved');
        }
        
        function loadProperties() {
            const saved = localStorage.getItem('properties');
            if (saved) {
                try {
                    properties = JSON.parse(saved);
                } catch (e) {
                    properties = [];
                }
            }
        }
        
        function saveProperties() {
            localStorage.setItem('properties', JSON.stringify(properties));
        }
        
        function renderPropertyList() {
            const listElement = document.getElementById('propertyList');
            const emptyState = document.getElementById('emptyState');
            
            if (properties.length === 0) {
                listElement.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            listElement.innerHTML = '';
            
            properties.forEach((prop) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'property-item';
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'property-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'property-name';
                nameDiv.textContent = prop.name;
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'property-details';
                
                if (prop.type === 'simple' && prop.simpleData) {
                    detailsDiv.textContent = `ç°¡æ˜“è¨ˆç®— | å®¶è³ƒ: ${fmt(prop.simpleData.rent)}/æœˆ | åˆ©å›ã‚Š: ${prop.simpleData.yield}%`;
                } else if (prop.type === 'detailed' && prop.detailedData) {
                    detailsDiv.textContent = `è©³ç´°åˆ†æ | ç‰©ä»¶: ${fmt(prop.detailedData.price)} | è¡¨é¢: ${prop.detailedData.gross.toFixed(1)}% | å®Ÿè³ª: ${prop.detailedData.net.toFixed(1)}%`;
                }
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(detailsDiv);
                
                const priceDiv = document.createElement('div');
                priceDiv.className = 'property-price';
                
                if (prop.type === 'simple' && prop.simpleData) {
                    priceDiv.textContent = fmt(prop.simpleData.price);
                } else if (prop.type === 'detailed' && prop.detailedData) {
                    priceDiv.textContent = fmt(prop.detailedData.totalInv);
                }
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'property-actions';
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-secondary btn-small';
                viewBtn.textContent = 'è©³ç´°';
                viewBtn.addEventListener('click', () => viewProperty(prop.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-secondary btn-small';
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.style.color = '#fca5a5';
                deleteBtn.addEventListener('click', () => deleteProperty(prop.id));
                
                actionsDiv.appendChild(viewBtn);
                actionsDiv.appendChild(deleteBtn);
                
                itemDiv.appendChild(infoDiv);
                itemDiv.appendChild(priceDiv);
                itemDiv.appendChild(actionsDiv);
                
                listElement.appendChild(itemDiv);
            });
        }
        
        function viewProperty(id) {
            const property = properties.find(p => p.id === id);
            if (!property) return;
            
            let msg = `ç‰©ä»¶å: ${property.name}\nä¿å­˜æ—¥æ™‚: ${property.savedAt}\n\n`;
            
            if (property.type === 'simple' && property.simpleData) {
                const d = property.simpleData;
                msg += `ã€ç°¡æ˜“è¨ˆç®—ã€‘\n` +
                       `æƒ³å®šå®¶è³ƒ: ${fmt(d.rent)}/æœˆ\n` +
                       `ç›®æ¨™åˆ©å›ã‚Š: ${d.yield}%\n` +
                       `ãƒªãƒ•ã‚©ãƒ¼ãƒ è²»ç”¨: ${fmt(d.reform)}\n` +
                       `å¹´é–“å®¶è³ƒ: ${fmt(d.annual)}\n` +
                       `æ¨å¥¨è³¼å…¥ä¾¡æ ¼: ${fmt(d.price)}`;
            } else if (property.type === 'detailed' && property.detailedData) {
                const d = property.detailedData;
                msg += `ã€è©³ç´°åˆ†æã€‘\n` +
                       `ç‰©ä»¶ä¾¡æ ¼: ${fmt(d.price)}\n` +
                       `ç·æŠ•è³‡é¡: ${fmt(d.totalInv)}\n` +
                       `åœŸåœ°å€¤: ${fmt(d.landValue)}\n` +
                       `è¡¨é¢åˆ©å›ã‚Š: ${d.gross.toFixed(2)}%\n` +
                       `å®Ÿè³ªåˆ©å›ã‚Š: ${d.net.toFixed(2)}%\n` +
                       `å¹´é–“CF: ${fmt(d.cf)}\n` +
                       `æœˆé–“CF: ${fmt(d.cf / 12)}\n` +
                       `è¿”æ¸ˆæ¯”ç‡: ${d.payRatio.toFixed(1)}%\n` +
                       `æŠ•è³‡å›å: ${d.payback.toFixed(1)}å¹´`;
            }
            
            alert(msg);
        }
        
        function deleteProperty(id) {
            if (!confirm('ã“ã®ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            properties = properties.filter(p => p.id !== id);
            saveProperties();
            renderPropertyList();
        }
        
        function exportData() {
            if (properties.length === 0) {
                alert('ä¿å­˜æ¸ˆã¿ã®ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const dataStr = JSON.stringify(properties, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) {
                        throw new Error('Invalid format');
                    }
                    
                    if (confirm(`${imported.length}ä»¶ã®ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                        properties = imported;
                        saveProperties();
                        renderPropertyList();
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                    }
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
    </script>
</body>
</html>